Docker Compose
---
---

[Почитать подробнее](https://dker.ru/)

Когда нам требуется развернуть только одно приложение, то достаточно
использовать Dockerfile, но если нам требуется развернуть множество 
контейнеров, для таких манипуляций можно использовать механизм
Docker Compose.

Docker Compose - позволяет решать различные задачи, связанные с 
управлением одновременно несколькими контейнерами, составляющих
в целом один проект.

---

**docker-compose.yml**

`docker-compose.yml` - документ для описания команд `docker compose`,
для запуска множества контейнеров в одном проекте, как и `Docekrfile`
должен располагаться в корне проекта, совместно с `Docekrfile`

Скажем у нас есть проект на Python, создадим для него `Dockerfile`
и опишем для него установку всех зависимостей.

```dockerfile
FROM python:3.8
ENV PYTHONUNBUFFERED 1
RUN mkdir /code
WORKDIR /code
ADD requirements.txt /code/
RUN pip install -r requirements.txt
ADD . /code/
```

В том же каталоге создадим файл `docker-compose.yml` этот файл 
описывает сервисы `services` каждый из таких сервисов, представляет
собой отдельный докер контейнер.

Сервисами могут быть web-серверы, базы данных, сервер nginx для 
запуска фронта отдельно от сервера бэка, чистый бэк в виде API.

Так же в файле описываются образы в котором будут развернуты 
эти самые сервисы, как они будут связаны и какие тома данных
нужно смонтировать в контейнеры, то есть какие директории с 
программным кодом будут скопированы в эти контейнеры, и описывает
какие именно порты будут открыты в основную ОС.

И так наш `docker-compose.yml` будет состоять из 2 сервисов.

```dockerfile
# Указание версии docekr compose
version: '3'

# Сервисы, каждый сервис это отдельный докер контейнер
services:

  # Название сервиса может быть любым, тут мы называем его db
  # в параметре image мы указываем изображение, в котором будет
  # развернут контейнер, тут мы указываем postgres и этот образ 
  # будет скачен с Docker Hub и установлен в контейнер       
  db:
    container_name: db01
    image: postgres
    
  # Контейнер для запуска сервера,     
  web:
  
    # Даем контейнеру специальное имя    
    container_name: web01
  
    # Мы указываем либо образ image который будет закчен с Hub
    # либо указываем свой образ созданный нами, тут точка означает
    # создать из текущей директории, учетом текущего Dockerfile      
    build: .
    
    # command указывает какую bash команду выполнить, тут запуск сервера    
    command: python manage.py runserver 0.0.0.0:8000
    
    # volumes - так называемые тома, путь директорий в которых 
    # будет храниться данные что находятся за пределами контейнеров    
    volumes:
      - .:/code
      
    # Указываем порт который требуется прокинуть между системами
    # Первый 8000 это порт в основной системе, второй 8000 это порт
    # который находится во внутренней системе контейнера         
    ports:
      - "8000:8000"
      
    # указываем зависимости, тоетсь с начала должен быть запущен
    # контейнер db и только после этого контейнер web          
    depends_on:
      - db
```

---

Когда мы создаем образ сервиса, то либо указываем изображение 
`image` либо `build` по сути `build` это конструктор, описывающий
как создать образ для сервиса, вот 2 способа его описания:

```dockerfile
    build: .
```

```dockerfile
    build:
      context: ./
      dockerfile: Dockerfile
```

---

`volumes` - тут можно указать путь к директории, эта директория 
будет местом хранения общих данных, данных что должны быть 
использованы между контейнерами. 

```dockerfile
volumes:
      - .:/code
```

---

